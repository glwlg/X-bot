# Learnings

- 2026-02-18: Repository state files now parse with marker-first precedence (`<!-- XBOT_STATE_BEGIN -->` / `<!-- XBOT_STATE_END -->`), then legacy fenced-yaml/frontmatter/raw fallbacks for backward compatibility.
- 2026-02-18: Canonical state-file writing should stay centralized so downstream repository-to-state-store migrations can reuse one markdown protocol implementation.
- 2026-02-18: Core-manager defaults should include `group:primitives` + `group:management`; when persisted allow list is legacy `['group:management']` with empty deny, auto-upgrade during load to avoid runtime primitive denial.
- 2026-02-18: Keep worker-default normalization untouched while upgrading only core-manager legacy `group:management`-only policy to include primitive tool groups.
- 2026-02-18: A deterministic migration scan can stay safe by enumerating only repository-owned business-state paths and classifying parse-fail files as `unparsable` so `--apply` rewrites only parseable legacy files.
- 2026-02-18: Protocol coverage is most stable when asserting exact canonical markers plus exactly one fenced `yaml` block, then validating parse roundtrip includes injected `version: 1` for dict payloads.
- 2026-02-18: Scoped state roundtrip tests can stay deterministic by using `mock_db` temporary DATA_DIR and writing directly to concrete user/system state paths for each domain.
- 2026-02-18: Porting repository logic into `core.state_store` can preserve behavior by keeping existing defaults (`user_id`, `auto_translate`, `target_lang`, `updated_at`) and continuing to read/write through `repositories.base` primitives (`user_path`, `read_json`, `write_json`).
- 2026-02-18: RSS subscriptions can be inlined into `core.state_store` without behavior drift by preserving normalization keys (`feed_url`, `title`, `platform`, `last_etag`, `last_modified`, `last_entry_hash`) and retaining runtime row IDs derived from 1-based row index.
- 2026-02-18: Watchlist migration follows the same low-drift porting pattern by inlining add/remove/list helpers into `core.state_store` and persisting `stock/watchlist.md` through shared `write_json`, which guarantees canonical marker+yaml output while `read_json` keeps legacy payload compatibility.
- 2026-02-18: Reminder domain can be ported into `core.state_store` with behavior parity by preserving `next_id("reminder")` allocation, `trigger_time` string-sort semantics, and writing `automation/reminders.md` through shared `write_json`; legacy reads remain safe by accepting both list payloads and dict payloads containing a `reminders` list.
- 2026-02-18: Scheduled-task migration can stay low-drift by inlining repository logic into `core.state_store` with unchanged APIs (`add_scheduled_task`, `get_all_active_tasks`, `update_task_status`, `delete_task`), keeping global `next_id("scheduled_task")` semantics, canonical `write_json` output to `automation/scheduled_tasks.md`, and legacy read compatibility for list payloads plus dict wrappers (`scheduled_tasks`/`tasks`).
- 2026-02-18: Allowed-users migration can preserve runtime semantics by inlining `_read_allowed` + `add/remove/get/check` into `core.state_store`, keeping `system_path("allowed_users.md")` persistence through shared `write_json` for canonical marker+yaml writes while `read_json` continues legacy frontmatter/fenced/raw payload compatibility.
- 2026-02-18: Base/cache primitive port stays behavior-safe by moving filesystem helpers into `core.state_paths` + `core.state_io`, wiring `core.state_store` video cache APIs directly to `system_path("video_cache.md")`, and preserving global `next_id` writes at canonical `data/system/repositories/id_counters.md` through shared markdown-state writer.
- 2026-02-18: Final repository-layer collapse succeeds by inlining `chat_repo` + `account_repo` logic directly into `core.state_store` with unchanged public API names, preserving chat markdown transcript layout (`data/users/<uid>/chat/<day>/<session>.md`) and account payload shape (`accounts.md` service->`{data,updated_at}`).
- 2026-02-18: A legacy verification script under `tests/` can avoid direct package imports by reading mocked modules from `sys.modules`, which removes stale `repositories` import usage without changing runtime behavior of the script itself.
- 2026-02-18: Final migration validation pass on temp DATA_DIR (`/tmp/state-mig-final-gMLt0p`) confirmed `src.core.state_migration --apply` rewrites only parseable legacy in-scope files (3 rewritten), preserves canonical/missing/unparsable classifications, and post-apply dry-run converges to `legacy=0` with `canonical=4`, `unparsable=1`, `missing=1`.
- 2026-02-18: Rewritten files in temp scope keep canonical contract (marker pair + single fenced `yaml` payload) with `version: 1` normalization, while out-of-scope `users/u_mixed/notes.md` stayed unchanged (sha256 identical before/after apply).
- 2026-02-18: Full regression gate passed with `uv run pytest` (`191 passed, 13 warnings`, 3.39s).
